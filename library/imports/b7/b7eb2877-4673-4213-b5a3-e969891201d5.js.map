{"version":3,"sources":["../../../../../assets/scripts/component/assets/scripts/component/EditorMap.js"],"names":["Map","require","cc","Class","extends","properties","refLine","default","undefined","type","Node","mapPosLabel","Label","onLoad","onDestroy","globalEvent","off","updateMap","node","mouseDownHandle","mouseMoveHandle","mouseUpHandle","mouseLeaveHandle","mouseEnterHandle","start","atlas","resMgr","getRes","resName","commonui","on","goBackMapPos","curPassData","passData","getCurPassData","commonConfig","getCommonConfig","mapInfo","configData","scale","updateMapPos","posx","posy","emit","mapSize","removeAllChildren","setContentSize","w","h","mapData","rowKey","rowData","colKey","colData","updateGrid","material","x","y","setPosition","string","parseInt","event","isMouseDown","gridInfo","mousePos","getLocation","oldPos","newPos","convertToNodeSpace","v2","getGridInfoByMousePos","curMousePos","Math","abs","pos","getDelta","isMouseMove","newX","newY","editorData","getCurEditorData","log","curMatieral","row","col","matNameToType","empty","utils","getPropertyOrInit","setIfUndef","savePass","getCurPassIdx"],"mappings":"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","file":"EditorMap.js","sourceRoot":"../../../../../assets/scripts/component","sourcesContent":["var Map = require(\"Map\")\ncc.Class({\n    extends:Map,\n    properties:{\n        refLine:{\n            default:undefined,\n            type:cc.Node,\n        },\n        mapPosLabel:{\n            default:undefined,\n            type:cc.Label,\n        }\n    },\n    onLoad(){\n        \n    },\n    onDestroy(){\n        cc.globalEvent.off(\"Editor:UpdateMap\",this.updateMap,this);\n        cc.globalEvent.off(\"Editor:UpdateMapPos\",this.updateMap,this);\n        this.node.off('mousedown',this.mouseDownHandle,this);\n        this.node.off('mousemove',this.mouseMoveHandle,this);\n        this.node.off('mouseup',this.mouseUpHandle,this);\n        this.node.off('mouseleave',this.mouseLeaveHandle,this);\n        this.node.off('mouseenter',this.mouseEnterHandle,this);\n\n        this.node.off('touchstart',this.mouseDownHandle,this);\n        this.node.off('touchmove',this.mouseMoveHandle,this);\n        this.node.off('touchend',this.mouseUpHandle,this);\n        this.node.off('touchcancel',this.mouseLeaveHandle,this);\n    },\n    start(){\n        this.atlas = cc.resMgr.getRes(cc.resName.commonui);\n\n        cc.globalEvent.on(\"Editor:UpdateMap\",this.updateMap,this);\n        cc.globalEvent.on(\"Editor:UpdateMapPos\",this.goBackMapPos,this);\n        this.node.on('mousedown',this.mouseDownHandle,this);\n        this.node.on('mousemove',this.mouseMoveHandle,this);\n        this.node.on('mouseup',this.mouseUpHandle,this);\n        this.node.on('mouseleave',this.mouseLeaveHandle,this);\n        this.node.on('mouseenter',this.mouseEnterHandle,this);\n\n        this.node.on('touchstart',this.mouseDownHandle,this);\n        this.node.on('touchmove',this.mouseMoveHandle,this);\n        this.node.on('touchend',this.mouseUpHandle,this);\n        this.node.on('touchcancel',this.mouseLeaveHandle,this);\n\n        this.curPassData = cc.passData.getCurPassData();\n        this.commonConfig = cc.passData.getCommonConfig();\n\n        this.updateMap();\n    },\n\n    goBackMapPos(){\n        var mapInfo = this.curPassData.configData.mapInfo;\n        this.node.scale = mapInfo.scale;\n        this.updateMapPos(mapInfo.posx,mapInfo.posy);\n    },\n    updateMap(){\n        cc.globalEvent.emit(\"Editor:UpdateMapBgSize\");\n        var mapSize = this.curPassData.mapSize;\n        this.node.removeAllChildren();\n        this.node.setContentSize(mapSize.w,mapSize.h);\n\n        var mapData = this.curPassData.configData.mapData;\n        for(var rowKey in mapData){\n            var rowData = mapData[rowKey];\n            \n            for(var colKey in rowData){\n                var colData = rowData[colKey];\n                this.updateGrid(rowKey,colKey,colData.material);\n            }\n        }\n        this.goBackMapPos();\n    },\n    updateMapPos(x,y){\n        this.node.setPosition(x,y);\n        this.refLine.setPosition(x,y);\n        this.mapPosLabel.string = \"x:\"+parseInt(this.node.x)+\" y:\"+parseInt(this.node.y);\n        cc.globalEvent.emit(\"Editor:UpdateMapBgPos\",{x:this.node.x,y:this.node.y,scale:this.node.scale});\n    },\n\n    mouseLeaveHandle(event){\n        this.isMouseDown = false;\n        cc.globalEvent.emit(\"Editor:UpdateGridHelp\",\n            {gridInfo:undefined,isMouseDown:false});\n    },\n    mouseEnterHandle(event){\n        \n    },\n    mouseDownHandle(event){\n        this.mousePos = event.getLocation();\n        this.isMouseDown = true;\n    },\n    mouseMoveHandle(event){\n        var oldPos = event.getLocation();\n        var newPos = this.node.convertToNodeSpace(cc.v2(oldPos.x, oldPos.y));\n        var gridInfo = this.curPassData.getGridInfoByMousePos(newPos.x,newPos.y);\n        \n        //console.log(oldPos.x,oldPos.y,newPos.x,newPos.y,gridInfo);\n\n        cc.globalEvent.emit(\"Editor:UpdateGridHelp\",\n            {gridInfo:gridInfo,isMouseDown:this.isMouseDown});\n\n        if(!this.isMouseDown){\n            return;\n        }\n\n        var curMousePos = event.getLocation();\n        if(Math.abs(this.mousePos.x - curMousePos.x)<2&&\n           Math.abs(this.mousePos.y - curMousePos.y)<2){\n            return;\n        }\n\n        var pos = event.getDelta();\n        this.isMouseMove = true;\n        var newX = this.node.x+pos.x;\n        var newY = this.node.y+pos.y;\n        this.updateMapPos(newX,newY);\n    },\n    mouseUpHandle(event){\n        if(!this.isMouseDown){\n            return;\n        }\n        this.isMouseDown = false;\n        if(this.isMouseMove){\n            this.isMouseMove = false;\n            return;\n        }\n        this.isMouseMove = false;\n\n        var oldPos = event.getLocation();\n        var newPos = this.node.convertToNodeSpace(cc.v2(oldPos.x, oldPos.y));\n        var gridInfo = this.curPassData.getGridInfoByMousePos(newPos.x,newPos.y);\n        if(!gridInfo){\n            return;\n        }\n\n        var editorData = cc.passData.getCurEditorData();\n        cc.log(\"use material:\",editorData.curMatieral);\n\n        var rowKey = gridInfo.row;\n        var colKey = gridInfo.col;\n        var mapData = this.curPassData.configData.mapData;\n        var material = undefined;\n\n        if(editorData.curMatieral == this.commonConfig.matNameToType.empty){\n            if(mapData[rowKey]&&mapData[rowKey][colKey])\n                delete mapData[rowKey][colKey].material;\n        }else{\n            material = cc.utils.getPropertyOrInit(mapData,rowKey,colKey,\"material\");\n            cc.utils.setIfUndef(material,editorData.curMatieral,0);\n            material[editorData.curMatieral]++;\n        }\n        cc.passData.savePass(cc.passData.getCurPassIdx());\n        this.updateGrid(rowKey,colKey,material);\n    },\n})"]}